<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - server_http_1.h</title></head><body bgcolor='white'><pre>
<font color='#009900'>// Copyright (C) 2006  Davis E. King (davis@dlib.net), Steven Van Ingelgem
</font><font color='#009900'>// License: Boost Software License   See LICENSE.txt for the full license.
</font><font color='#0000FF'>#ifndef</font> DLIB_SERVER_HTTp_1_
<font color='#0000FF'>#define</font> DLIB_SERVER_HTTp_1_


<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='server_iostream_abstract.h.html'>server_iostream_abstract.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='server_http_abstract.h.html'>server_http_abstract.h</a>"
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>iostream<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>sstream<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>string<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../logger.h.html'>../logger.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../string.h.html'>../string.h</a>"

<font color='#0000FF'>#ifdef</font>  __INTEL_COMPILER
<font color='#009900'>// ignore the bogus warning about hiding on_connect()
</font><font color='#0000FF'>#pragma</font> warning <font face='Lucida Console'>(</font>disable: <font color='#979000'>1125</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> _MSC_VER
#  pragma <b><a name='warning'></a>warning</b><font face='Lucida Console'>(</font> disable: <font color='#979000'>4503</font> <font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>// _MSC_VER
</font>

<font color='#0000FF'>namespace</font> dlib
<b>{</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> server_base
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>class</font> <b><a name='server_http_1'></a>server_http_1</b> : <font color='#0000FF'>public</font> server_base 
    <b>{</b>

        <font color='#009900'>/*!
            CONVENTION
                this extension doesn't add any new state to this object.
        !*/</font>


    <font color='#0000FF'>public</font>:

        <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Key, <font color='#0000FF'>typename</font> Value<font color='#5555FF'>&gt;</font>
        <font color='#0000FF'>class</font> <b><a name='constmap'></a>constmap</b> : <font color='#0000FF'>public</font> std::map<font color='#5555FF'>&lt;</font>Key, Value<font color='#5555FF'>&gt;</font>
        <b>{</b>
        <font color='#0000FF'>public</font>:
            <font color='#0000FF'>const</font> Value<font color='#5555FF'>&amp;</font> <b><a name='operator'></a>operator</b>[]<font face='Lucida Console'>(</font><font color='#0000FF'>const</font> Key<font color='#5555FF'>&amp;</font> k<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
            <b>{</b>
                <font color='#0000FF'>static</font> <font color='#0000FF'>const</font> Value dummy <font color='#5555FF'>=</font> <font color='#BB00BB'>Value</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

                <font color='#0000FF'>typename</font> std::map<font color='#5555FF'>&lt;</font>Key, Value<font color='#5555FF'>&gt;</font>::const_iterator ci <font color='#5555FF'>=</font> std::map<font color='#5555FF'>&lt;</font>Key, Value<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>find</font><font face='Lucida Console'>(</font>k<font face='Lucida Console'>)</font>;

                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> ci <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#0000FF'>this</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font face='Lucida Console'>)</font>
                    <font color='#0000FF'>return</font> dummy;
                <font color='#0000FF'>else</font>
                    <font color='#0000FF'>return</font> ci<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second;
            <b>}</b>

            Value<font color='#5555FF'>&amp;</font> <b><a name='operator'></a>operator</b>[]<font face='Lucida Console'>(</font><font color='#0000FF'>const</font> Key<font color='#5555FF'>&amp;</font> k<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>return</font> std::map<font color='#5555FF'>&lt;</font>Key, Value<font color='#5555FF'>&gt;</font>::<font color='#0000FF'>operator</font> []<font face='Lucida Console'>(</font>k<font face='Lucida Console'>)</font>;
            <b>}</b>
        <b>}</b>;

        <font color='#0000FF'>typedef</font> constmap<font color='#5555FF'>&lt;</font> std::string, std::string <font color='#5555FF'>&gt;</font> key_value_map;


        <font color='#0000FF'>struct</font> <b><a name='incoming_things'></a>incoming_things</b> 
        <b>{</b>
            <b><a name='incoming_things'></a>incoming_things</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> : foreign_port<font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>, local_port<font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

            std::string path;
            std::string request_type;
            std::string content_type;
            std::string body;

            key_value_map queries;
            key_value_map cookies;
            key_value_map headers;

            std::string foreign_ip;
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> foreign_port;
            std::string local_ip;
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> local_port;
        <b>}</b>;

        <font color='#0000FF'>struct</font> <b><a name='outgoing_things'></a>outgoing_things</b> 
        <b>{</b>
            <b><a name='outgoing_things'></a>outgoing_things</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> : http_return<font face='Lucida Console'>(</font><font color='#979000'>200</font><font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

            key_value_map  cookies;
            key_value_map  headers;
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> http_return;
            std::string    http_return_status;
        <b>}</b>;


    <font color='#0000FF'>private</font>:
        <font color='#0000FF'>virtual</font> <font color='#0000FF'>const</font> std::string <b><a name='on_request'></a>on_request</b> <font face='Lucida Console'>(</font>
            <font color='#0000FF'>const</font> incoming_things<font color='#5555FF'>&amp;</font> incoming,
            outgoing_things<font color='#5555FF'>&amp;</font> outgoing
        <font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <b><a name='to_hex'></a>to_hex</b><font face='Lucida Console'>(</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> x <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> 
        <b>{</b>
            <font color='#0000FF'>return</font> x <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&gt;</font> <font color='#979000'>9</font> ? <font face='Lucida Console'>(</font>'<font color='#FF0000'>A</font>'<font color='#5555FF'>-</font><font color='#979000'>10</font><font face='Lucida Console'>)</font> : '<font color='#FF0000'>0</font>'<font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#0000FF'>const</font> std::string <b><a name='urlencode'></a>urlencode</b><font face='Lucida Console'>(</font> <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> s <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> 
        <b>{</b>
            std::ostringstream os;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font> std::string::const_iterator ci <font color='#5555FF'>=</font> s.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; ci <font color='#5555FF'>!</font><font color='#5555FF'>=</font> s.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>ci <font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>ci <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>a</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font>ci <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>z</font>'<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
                     <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>ci <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>A</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font>ci <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>Z</font>'<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
                     <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>ci <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>0</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font>ci <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>9</font>'<font face='Lucida Console'>)</font> <font face='Lucida Console'>)</font>
                <b>{</b> <font color='#009900'>// allowed
</font>                    os <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#5555FF'>*</font>ci;
                <b>}</b>
                <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> <font color='#5555FF'>*</font>ci <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'> </font>'<font face='Lucida Console'>)</font>
                <b>{</b>
                    os <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>+</font>';
                <b>}</b>
                <font color='#0000FF'>else</font>
                <b>{</b>
                    os <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>%</font>' <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#BB00BB'>to_hex</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>ci <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#BB00BB'>to_hex</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>ci <font color='#5555FF'>%</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>;
                <b>}</b>
            <b>}</b>

            <font color='#0000FF'>return</font> os.<font color='#BB00BB'>str</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <b><a name='from_hex'></a>from_hex</b> <font face='Lucida Console'>(</font>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> ch
        <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>9</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ch <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>0</font>'<font face='Lucida Console'>)</font>
                ch <font color='#5555FF'>-</font><font color='#5555FF'>=</font> '<font color='#FF0000'>0</font>';
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>f</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ch <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>a</font>'<font face='Lucida Console'>)</font>
                ch <font color='#5555FF'>-</font><font color='#5555FF'>=</font> '<font color='#FF0000'>a</font>' <font color='#5555FF'>-</font> <font color='#979000'>10</font>;
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>F</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ch <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>A</font>'<font face='Lucida Console'>)</font>
                ch <font color='#5555FF'>-</font><font color='#5555FF'>=</font> '<font color='#FF0000'>A</font>' <font color='#5555FF'>-</font> <font color='#979000'>10</font>;
            <font color='#0000FF'>else</font> 
                ch <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <font color='#0000FF'>return</font> ch;
        <b>}</b>

        <font color='#0000FF'>const</font> std::string <b><a name='urldecode'></a>urldecode</b> <font face='Lucida Console'>(</font>
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> str
        <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#0000FF'>using</font> <font color='#0000FF'>namespace</font> std;
            string result;
            string::size_type i;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> str.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>str[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>+</font>'<font face='Lucida Console'>)</font>
                <b>{</b>
                    result <font color='#5555FF'>+</font><font color='#5555FF'>=</font> '<font color='#FF0000'> </font>';
                <b>}</b>
                <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>str[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>%</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> str.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> i<font color='#5555FF'>+</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    <font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> ch1 <font color='#5555FF'>=</font> <font color='#BB00BB'>from_hex</font><font face='Lucida Console'>(</font>str[i<font color='#5555FF'>+</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> ch2 <font color='#5555FF'>=</font> <font color='#BB00BB'>from_hex</font><font face='Lucida Console'>(</font>str[i<font color='#5555FF'>+</font><font color='#979000'>2</font>]<font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> ch <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ch1 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> ch2;
                    result <font color='#5555FF'>+</font><font color='#5555FF'>=</font> ch;
                    i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
                <b>}</b>
                <font color='#0000FF'>else</font>
                <b>{</b>
                    result <font color='#5555FF'>+</font><font color='#5555FF'>=</font> str[i];
                <b>}</b>
            <b>}</b>
            <font color='#0000FF'>return</font> result;
        <b>}</b>

        <font color='#0000FF'><u>void</u></font> <b><a name='parse_url'></a>parse_url</b><font face='Lucida Console'>(</font>std::string word, key_value_map<font color='#5555FF'>&amp;</font> queries<font face='Lucida Console'>)</font>
        <font color='#009900'>/*!
            Parses the query string of a URL.  word should be the stuff that comes
            after the ? in the query URL.
        !*/</font>
        <b>{</b>
            std::string::size_type pos;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>=</font> <font color='#979000'>0</font>; pos <font color='#5555FF'>&lt;</font> word.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pos<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>word[pos] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>&amp;</font>'<font face='Lucida Console'>)</font>
                    word[pos] <font color='#5555FF'>=</font> '<font color='#FF0000'> </font>';
            <b>}</b>

            std::istringstream <font color='#BB00BB'>sin</font><font face='Lucida Console'>(</font>word<font face='Lucida Console'>)</font>;
            sin <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> word;
            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>sin<font face='Lucida Console'>)</font>
            <b>{</b>
                pos <font color='#5555FF'>=</font> word.<font color='#BB00BB'>find_first_of</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>=</font>"<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>!</font><font color='#5555FF'>=</font> std::string::npos<font face='Lucida Console'>)</font>
                <b>{</b>
                    std::string key <font color='#5555FF'>=</font> <font color='#BB00BB'>urldecode</font><font face='Lucida Console'>(</font>word.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>,pos<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                    std::string value <font color='#5555FF'>=</font> <font color='#BB00BB'>urldecode</font><font face='Lucida Console'>(</font>word.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font>pos<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                    queries[key] <font color='#5555FF'>=</font> value;
                <b>}</b>
                sin <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> word;
            <b>}</b>
        <b>}</b>

        <font color='#0000FF'><u>void</u></font> <b><a name='on_connect'></a>on_connect</b> <font face='Lucida Console'>(</font>
            std::istream<font color='#5555FF'>&amp;</font> in,
            std::ostream<font color='#5555FF'>&amp;</font> out,
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> foreign_ip,
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> local_ip,
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> foreign_port,
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> local_port,
            uint64
        <font face='Lucida Console'>)</font>
        <b>{</b>
            <font color='#0000FF'><u>bool</u></font> my_fault <font color='#5555FF'>=</font> <font color='#979000'>true</font>;

            <font color='#0000FF'>using</font> <font color='#0000FF'>namespace</font> std;

            <font color='#0000FF'>try</font>
            <b>{</b>
                incoming_things incoming;
                outgoing_things outgoing;

                incoming.foreign_ip   <font color='#5555FF'>=</font> foreign_ip;
                incoming.foreign_port <font color='#5555FF'>=</font> foreign_port;
                incoming.local_ip     <font color='#5555FF'>=</font> local_ip;
                incoming.local_port   <font color='#5555FF'>=</font> local_port;

                in <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> incoming.request_type;

                <font color='#009900'>// get the path
</font>                in <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> incoming.path;

                key_value_map<font color='#5555FF'>&amp;</font> incoming_headers <font color='#5555FF'>=</font> incoming.headers;
                key_value_map<font color='#5555FF'>&amp;</font> cookies          <font color='#5555FF'>=</font> incoming.cookies;
                std::string<font color='#5555FF'>&amp;</font> path               <font color='#5555FF'>=</font> incoming.path;
                std::string<font color='#5555FF'>&amp;</font> content_type       <font color='#5555FF'>=</font> incoming.content_type;
                <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font> content_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

                string line;
                <font color='#BB00BB'>getline</font><font face='Lucida Console'>(</font>in,line<font face='Lucida Console'>)</font>;
                string first_part_of_header;
                string::size_type position_of_double_point;
                <font color='#009900'>// now loop over all the incoming_headers
</font>                <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    position_of_double_point <font color='#5555FF'>=</font> line.<font color='#BB00BB'>find_first_of</font><font face='Lucida Console'>(</font>'<font color='#FF0000'>:</font>'<font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> position_of_double_point <font color='#5555FF'>!</font><font color='#5555FF'>=</font> string::npos <font face='Lucida Console'>)</font>
                    <b>{</b>
                        first_part_of_header <font color='#5555FF'>=</font> dlib::<font color='#BB00BB'>trim</font><font face='Lucida Console'>(</font>line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, position_of_double_point<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> <font color='#5555FF'>!</font>incoming_headers[first_part_of_header].<font color='#BB00BB'>empty</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font face='Lucida Console'>)</font>
                            incoming_headers[ first_part_of_header ] <font color='#5555FF'>+</font><font color='#5555FF'>=</font> "<font color='#CC0000'> </font>";
                        incoming_headers[first_part_of_header] <font color='#5555FF'>+</font><font color='#5555FF'>=</font> dlib::<font color='#BB00BB'>trim</font><font face='Lucida Console'>(</font>line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font>position_of_double_point<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                        <font color='#009900'>// look for Content-Type:
</font>                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>14</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>strings_equal_ignore_case</font><font face='Lucida Console'>(</font>line, "<font color='#CC0000'>Content-Type:</font>", <font color='#979000'>13</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                        <b>{</b>
                            content_type <font color='#5555FF'>=</font> line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>14</font><font face='Lucida Console'>)</font>;
                            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>content_type[content_type.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>\r</font>'<font face='Lucida Console'>)</font>
                                content_type.<font color='#BB00BB'>erase</font><font face='Lucida Console'>(</font>content_type.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
                        <b>}</b>
                        <font color='#009900'>// look for Content-Length:
</font>                        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>16</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>strings_equal_ignore_case</font><font face='Lucida Console'>(</font>line, "<font color='#CC0000'>Content-Length:</font>", <font color='#979000'>15</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                        <b>{</b>
                            istringstream <font color='#BB00BB'>sin</font><font face='Lucida Console'>(</font>line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>16</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                            sin <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> content_length;
                            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>sin<font face='Lucida Console'>)</font>
                                content_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                        <b>}</b>
                        <font color='#009900'>// look for any cookies
</font>                        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>6</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>strings_equal_ignore_case</font><font face='Lucida Console'>(</font>line, "<font color='#CC0000'>Cookie:</font>", <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                        <b>{</b>
                            string::size_type pos <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
                            string key, value;
                            <font color='#0000FF'><u>bool</u></font> seen_key_start <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                            <font color='#0000FF'><u>bool</u></font> seen_equal_sign <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>+</font> <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font> line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                            <b>{</b>
                                <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pos;
                                <font color='#009900'>// ignore whitespace between cookies
</font>                                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>seen_key_start <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> line[pos] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'> </font>'<font face='Lucida Console'>)</font>
                                    <font color='#0000FF'>continue</font>;

                                seen_key_start <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>seen_equal_sign<font face='Lucida Console'>)</font> 
                                <b>{</b>
                                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line[pos] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>=</font>'<font face='Lucida Console'>)</font>
                                    <b>{</b>
                                        seen_equal_sign <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                                    <b>}</b>
                                    <font color='#0000FF'>else</font>
                                    <b>{</b>
                                        key <font color='#5555FF'>+</font><font color='#5555FF'>=</font> line[pos];
                                    <b>}</b>
                                <b>}</b>
                                <font color='#0000FF'>else</font>
                                <b>{</b>
                                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line[pos] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>;</font>'<font face='Lucida Console'>)</font>
                                    <b>{</b>
                                        cookies[<font color='#BB00BB'>urldecode</font><font face='Lucida Console'>(</font>key<font face='Lucida Console'>)</font>] <font color='#5555FF'>=</font> <font color='#BB00BB'>urldecode</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font>;
                                        seen_equal_sign <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                                        seen_key_start <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                                        key.<font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                                        value.<font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                                    <b>}</b>
                                    <font color='#0000FF'>else</font>
                                    <b>{</b>
                                        value <font color='#5555FF'>+</font><font color='#5555FF'>=</font> line[pos];
                                    <b>}</b>
                                <b>}</b>
                            <b>}</b>
                            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>key.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                            <b>{</b>
                                cookies[<font color='#BB00BB'>urldecode</font><font face='Lucida Console'>(</font>key<font face='Lucida Console'>)</font>] <font color='#5555FF'>=</font> <font color='#BB00BB'>urldecode</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font>;
                                key.<font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                                value.<font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                            <b>}</b>
                        <b>}</b>
                    <b>}</b> <font color='#009900'>// no ':' in it!
</font>                    <font color='#BB00BB'>getline</font><font face='Lucida Console'>(</font>in,line<font face='Lucida Console'>)</font>;
                <b>}</b> <font color='#009900'>// while (line.size() &gt; 2 )
</font>
                <font color='#009900'>// If there is data being posted back to us then load it into the incoming.body
</font>                <font color='#009900'>// string.
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> content_length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font face='Lucida Console'>)</font>
                <b>{</b>
                    incoming.body.<font color='#BB00BB'>resize</font><font face='Lucida Console'>(</font>content_length<font face='Lucida Console'>)</font>;
                    in.<font color='#BB00BB'>read</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>incoming.body[<font color='#979000'>0</font>],content_length<font face='Lucida Console'>)</font>;
                <b>}</b>

                <font color='#009900'>// If there is data being posted back to us as a query string then
</font>                <font color='#009900'>// pick out the queries using parse_url.
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>strings_equal_ignore_case</font><font face='Lucida Console'>(</font>incoming.request_type, "<font color='#CC0000'>POST</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> 
                    <font color='#BB00BB'>strings_equal_ignore_case</font><font face='Lucida Console'>(</font><font color='#BB00BB'>left_substr</font><font face='Lucida Console'>(</font>content_type,"<font color='#CC0000'>;</font>"<font face='Lucida Console'>)</font>, "<font color='#CC0000'>application/x-www-form-urlencoded</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    <font color='#BB00BB'>parse_url</font><font face='Lucida Console'>(</font>incoming.body, incoming.queries<font face='Lucida Console'>)</font>;
                <b>}</b>

                string::size_type pos <font color='#5555FF'>=</font> path.<font color='#BB00BB'>find_first_of</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>?</font>"<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>!</font><font color='#5555FF'>=</font> string::npos<font face='Lucida Console'>)</font>
                <b>{</b>
                    <font color='#BB00BB'>parse_url</font><font face='Lucida Console'>(</font>path.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font>pos<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>, incoming.queries<font face='Lucida Console'>)</font>;
                <b>}</b>


                my_fault <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                key_value_map<font color='#5555FF'>&amp;</font> new_cookies      <font color='#5555FF'>=</font> outgoing.cookies;
                key_value_map<font color='#5555FF'>&amp;</font> response_headers <font color='#5555FF'>=</font> outgoing.headers;

                <font color='#009900'>// Set some defaults
</font>                outgoing.http_return        <font color='#5555FF'>=</font> <font color='#979000'>200</font>;
                outgoing.http_return_status <font color='#5555FF'>=</font> "<font color='#CC0000'>OK</font>";

                <font color='#009900'>// if there wasn't a problem with the input stream at some point
</font>                <font color='#009900'>// then lets trigger this request callback.
</font>                std::string result;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>in<font face='Lucida Console'>)</font>
                    result <font color='#5555FF'>=</font> <font color='#BB00BB'>on_request</font><font face='Lucida Console'>(</font>incoming, outgoing<font face='Lucida Console'>)</font>;
                my_fault <font color='#5555FF'>=</font> <font color='#979000'>true</font>;

                <font color='#009900'>// only send this header if the user hasn't told us to send another kind
</font>                <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>has_content_type</font><font face='Lucida Console'>(</font><font color='#979000'>false</font><font face='Lucida Console'>)</font>,
                     <font color='#BB00BB'>has_location</font><font face='Lucida Console'>(</font><font color='#979000'>false</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>for</font><font face='Lucida Console'>(</font> <font color='#0000FF'>typename</font> key_value_map::const_iterator ci <font color='#5555FF'>=</font> response_headers.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; ci <font color='#5555FF'>!</font><font color='#5555FF'>=</font> response_headers.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>ci <font face='Lucida Console'>)</font>
                <b>{</b>
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> <font color='#5555FF'>!</font>has_content_type <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>strings_equal_ignore_case</font><font face='Lucida Console'>(</font>ci<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first , "<font color='#CC0000'>content-type</font>"<font face='Lucida Console'>)</font> <font face='Lucida Console'>)</font>
                    <b>{</b>
                        has_content_type <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                    <b>}</b>
                    <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> <font color='#5555FF'>!</font>has_location <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>strings_equal_ignore_case</font><font face='Lucida Console'>(</font>ci<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first , "<font color='#CC0000'>location</font>"<font face='Lucida Console'>)</font> <font face='Lucida Console'>)</font>
                    <b>{</b>
                        has_location <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                    <b>}</b>
                <b>}</b>

                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> has_location <font face='Lucida Console'>)</font>
                <b>{</b>
                    outgoing.http_return <font color='#5555FF'>=</font> <font color='#979000'>302</font>;
                <b>}</b>

                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> <font color='#5555FF'>!</font>has_content_type <font face='Lucida Console'>)</font>
                <b>{</b>
                    response_headers["<font color='#CC0000'>Content-Type</font>"] <font color='#5555FF'>=</font> "<font color='#CC0000'>text/html</font>";
                <b>}</b>

                <b>{</b>
                    ostringstream os;
                    os <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> result.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

                    response_headers["<font color='#CC0000'>Content-Length</font>"] <font color='#5555FF'>=</font> os.<font color='#BB00BB'>str</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                <b>}</b>

                out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>HTTP/1.0 </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> outgoing.http_return <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> outgoing.http_return_status <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\r\n</font>";

                <font color='#009900'>// Set any new headers
</font>                <font color='#0000FF'>for</font><font face='Lucida Console'>(</font> <font color='#0000FF'>typename</font> key_value_map::const_iterator ci <font color='#5555FF'>=</font> response_headers.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; ci <font color='#5555FF'>!</font><font color='#5555FF'>=</font> response_headers.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>ci <font face='Lucida Console'>)</font>
                <b>{</b>
                    out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> ci<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> ci<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\r\n</font>";
                <b>}</b>

                <font color='#009900'>// set any cookies 
</font>                <font color='#0000FF'>for</font><font face='Lucida Console'>(</font> <font color='#0000FF'>typename</font> key_value_map::const_iterator ci <font color='#5555FF'>=</font> new_cookies.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; ci <font color='#5555FF'>!</font><font color='#5555FF'>=</font> new_cookies.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>ci <font face='Lucida Console'>)</font>
                <b>{</b>
                    out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>Set-Cookie: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#BB00BB'>urlencode</font><font face='Lucida Console'>(</font>ci<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>=</font>' <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#BB00BB'>urlencode</font><font face='Lucida Console'>(</font>ci<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\r\n</font>";
                <b>}</b>
                out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\r\n</font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> result;
            <b>}</b>
            <font color='#0000FF'>catch</font> <font face='Lucida Console'>(</font>std::bad_alloc<font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font>
            <b>{</b>
                dlog <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> LERROR <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>We ran out of memory in server_http::on_connect()</font>";
                <font color='#009900'>// If this is an escaped exception from on_request then let it fly! 
</font>                <font color='#009900'>// Seriously though, this way it is obvious to the user that something bad happened
</font>                <font color='#009900'>// since they probably won't have the dlib logger enabled.
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>my_fault<font face='Lucida Console'>)</font>
                    <font color='#0000FF'>throw</font>;
            <b>}</b>

        <b>}</b>

        <font color='#0000FF'>const</font> <font color='#0000FF'>static</font> logger dlog;
    <b>}</b>;

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> server_base
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> logger server_http_1<font color='#5555FF'>&lt;</font>server_base<font color='#5555FF'>&gt;</font>::<b><a name='dlog'></a>dlog</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>dlib.server</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>// DLIB_SERVER_HTTp_1_
</font>




</pre></body></html>